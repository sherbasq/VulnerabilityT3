package testUI;

import ApiClient.FactoryRequest;
import io.restassured.response.Response;
import org.junit.After;
import org.junit.Before;
import org.junit.Test;



public class VulnerabilityTest {
    @Before
    public void before(){

    }
    @Test
    public void verifyVulnerabilityScanTest() throws InterruptedException {
        String idScan=starScanOWASP();
        monitoringStateScan(idScan);
    }
    @After
    public void after(){
        generateReportScan();
    }

    public String starScanOWASP(){
        //Iniciar scan----Obtener id
        String starScanUrl = "http://127.0.0.1:8888/JSON/ascan/action/scan/?url=\"https://todoist.com/\"&recurse=&inScopeOnly=&scanPolicyName=&method=&postData=&contextId=";
        Response response = FactoryRequest.make("get").send(starScanUrl);
        response.prettyPrint();
        String scanId = response.then().extract().path("scan");
        System.out.println("ID: " + scanId);
        return scanId;
    }

    public void monitoringStateScan(String scanId) throws InterruptedException {
        //Monitorear Scan con ID
        String getStateUrl = "http://127.0.0.1:8888/JSON/ascan/view/status/?scanId=" + scanId;
        String isComplete = "";
        while (!isComplete.equals("100")) {
            Thread.sleep(30000);
            Response responseStatus = FactoryRequest.make("get").send(getStateUrl);
            isComplete = responseStatus.then().extract().path("status");
            System.out.println("Scan Status: " + isComplete + " %");
        }
    }

    public void generateReportScan(){
        //Recuperar reporte de ataques
        String getReportHtml = "http://127.0.0.1:8888/OTHER/core/other/htmlreport/";
        Response responseReport = FactoryRequest.make("get").send(getReportHtml);
        String htmlReport=responseReport.body().asString();

    }
}
