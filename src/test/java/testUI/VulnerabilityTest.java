package testUI;

import ApiClient.FactoryRequest;
import io.qameta.allure.Attachment;
import io.qameta.allure.Description;
import io.qameta.allure.Owner;
import io.qameta.allure.Step;
import io.qameta.allure.junit4.DisplayName;
import io.restassured.response.Response;
import org.junit.After;
import org.junit.Before;
import org.junit.Test;



public class VulnerabilityTest {
    String globalIdScan="";
    @Before
    public void before(){

    }

    @DisplayName("Verificar vulnerabilidad de aplicacion")
    @Description("Este testCase es para verificar seguridad de aplicacion con OWASP")
    @Owner("Sergio Herbas")
    @Test
    public void verifyVulnerabilityScanTest() throws InterruptedException {
        globalIdScan=starScanOWASP();
        monitoringStateScan(globalIdScan);
    }
    @After
    public void after(){
        generateReportScan();
    }

    @Attachment(value = "{0}", type = "text/html")
    public static String atachReportHtml(String name,String html){
        return html;
    }

    @Step("Star Scan of the app")
    public String starScanOWASP(){
        //Iniciar scan----Obtener id
        String starScanUrl = "http://127.0.0.1:8888/JSON/ascan/action/scan/?url=\"https://todoist.com/\"&recurse=&inScopeOnly=&scanPolicyName=&method=&postData=&contextId=";
        Response response = FactoryRequest.make("get").send(starScanUrl);
        response.prettyPrint();
        String scanId = response.then().extract().path("scan");
        System.out.println("ID: " + scanId);
        return scanId;
    }

    @Step("Monitoring Scan of the app")
    public void monitoringStateScan(String scanId) throws InterruptedException {
        //Monitorear Scan con ID
        String getStateUrl = "http://127.0.0.1:8888/JSON/ascan/view/status/?scanId=" + scanId;
        String isComplete = "";
        while (!isComplete.equals("100")) {
            Thread.sleep(30000);
            Response responseStatus = FactoryRequest.make("get").send(getStateUrl);
            isComplete = responseStatus.then().extract().path("status");
            System.out.println("Scan Status: " + isComplete + " %");
        }
    }


    public void generateReportScan(){
        //Recuperar reporte de ataques
        String getReportHtml = "http://127.0.0.1:8888/OTHER/core/other/htmlreport/";
        Response responseReport = FactoryRequest.make("get").send(getReportHtml);
        String htmlReport=responseReport.body().asString();
        atachReportHtml("Vulnaribility Report",htmlReport);

        String getSummaryReportHMTL="http://127.0.0.1:8888/HTML/ascan/view/scanProgress/?scanId="+globalIdScan;
        responseReport=FactoryRequest.make("get").send(getSummaryReportHMTL);
        String htmlSumaryReport=responseReport.body().asString();
        atachReportHtml("OWASP Summary Report ",htmlSumaryReport);



    }
}
